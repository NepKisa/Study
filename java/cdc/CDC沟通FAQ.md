     CDC沟通FAQ
1. 什么是CDC？
CDC（Changed Data Capture），变化数据捕捉，是一种数据库实时数据采集方案，通过读取数据库的日志，实时捕捉数据库的数据变更。

2. CDC跟文件卸数的关系？
CDC能做到对供数系统侵入最小的情况下，实现高效的实时增量数据导出，大幅减少供数系统的数据导出量，缓解供数系统现有的数据导出对系统带来的负载压力。

3. 为什么要接入CDC？
根据数字化转型要求，兴业数金技术委员会会议明确要求“数据采集方式应大规模、大范围地由‘因需’转变为‘预制’”，同时也对数据加工时效性问题提出了明确的要求。按照上述会议指示要求，为了能够整体提升本行数据服务的时效性，计划进一步扩大实时数据采集范围，对未部署数据库实时采集（CDC）的存量系统展开全面的接入部署工作。

4. 接入系统的数据库需要做什么配置？
Oracle：
（1）在数据库中开启数据库日志
（2）创建表空间，大小为500M
（3）创建并授权采集用户查询权限
Informix：
（1）在数据库中开启数据库日志
（2）创建CDC数据库
（3）创建并授权采集用户查询权限
MySQL：
（1）在数据库中开启数据库日志
（2）创建并授权采集用户查询权限
以上皆为配置层面的操作，不涉及代码开发
具体参考《兴业数字金融服务（上海）股份有限公司数据库实时数据采集适用指引》中附录的接入手册

5. 支持CDC采集的数据库类型及版本？
MySQL：5.7及以上（5.7以下待验证）
Oracle:11.2.0.4及以上
Informix:11.5及以上
  
6. CDC实时采集发生故障时，怎么恢复？
当CDC发生断采时，会记录断采的日志位置，当该位置的日志文件未被清理时，CDC恢复采集，就会从断采的位置继续采集；如根据日志清理策略，该位置的日志文件已被清理，会从当前实时位置开始采集。

7. CDC接入数据库后对数据库的影响？（参考）
Oracle：
（1） 内存：官方建议预留2g内存给CDC（Xstream），Xstream可配置表清单过滤，当接入表较少且数据变更较少时，内存占用很小。
（2） 磁盘空间：会新建一个500M的缓存表的表空间以及会占用sysaux表空间的存储，占用情况视数据量和事务大小来定。
（3） 日志：数据库日志会有一定的增长，与表大小，数据库操作有关
（4） 其他：暂未发现其他资源消耗情况
MySQL/Informix：数据库接入CDC后，对数据库影响很小（事务临时数据和缓存数据都在采集器中处理，其中对于MySQL数据库，CDC的工作是连接到数据库，解析数据库的binlog日志，返回解析数据，并不在源系统上做计算，所以对源系统数据库影响很小）

8. 关于接入方系统接入CDC时流程问题

具体参考《兴业数字金融服务（上海）股份有限公司数据库实时数据采集适用指引》

9. 是不是所有表都要接入CDC？
按接入的优先级分成三类，业务需求只讨论第一点：
（1） 有业需提到的CDC的表数据，必须接入
（2） EDIP 已经发布的表
（3） 上游自己决定
如果没有暂时业务需求使用，首次接入时，仅需提供8-10张表，尽量选择：
（1）不涉及跑批（执行DML的批量数据处理）及大事务（一次事务变更一万条记录以上）操作的表
（2）每天数据都有变化的表，便于监控采集任务
（3）Informix：很少会做DDL变更的表，因为开启CDC，正在被采集的表会锁表，具体参考《兴业数字金融服务（上海）股份有限公司数据库实时数据采集适用指引》

10. 关于采集用户授权问题，是否对接入方数据库有侵入风险？
采集用户只有基本的查询权限，也不访问数据库数据，只访问日志，对数据库无侵入风险

11. CDC数据同步的时效性？
Oracle：tps 3000/s
Informix：tps 6000/s
MySQL：tps 3000/s
TPS不高的情况下，数据同步基本上是秒级。加上数据加工计算之后，查询到的数据会有一些延时

12. DML和DDL操作都能支持采集吗？
支持，但某些字段不支持采集，比如Oracle中的CLOB；Informix中的lvarchar，text等。CDC在采集表时，可根据字段名称筛选，过滤不支持的字段类型

13. 用了CDC会不会影响Oracle的DataGuard？
会共享部分内存空间，可适当调整内存大小。如有Dataguard，请与实时数据服务项目组陈思玥（892728）具体沟通。

14. 如果数据库重启后，恢复CDC采集，源系统需要做什么其他步骤吗？
不需要，只要CDC采集器重启即可恢复

15. 后续如果做数据清理，做大批量的数据删除，对于CDC有影响吗？需要关掉吗？
如果有大批量数据删除（或者大事务），需要在测试环境模拟生产环境数据量测试，然后评估sysaux表空间大小。如有此类数据库操作，请与实时数据服务项目组陈思玥（892728）具体沟通。

16. 上游数据库部署架构为主备，CDC数据库配置需要在哪台机器上做？
需要看备库是否支持CDC接入，如果是MySQL或者Oracle的热备，一般都支持采集备库，则主备库都需配置CDC，冷备不支持采集，灾备可以先不接入，则只接主库；而Informix只支持采集主库。
17. CDC捕获到的是数据还是操作？
变更前后的数据

18. 采集到的数据存储在哪里？
数据中台，如有业务需求使用，按照实际业务需求来存储，如没有业务需求使用，则在kafka里存储7天

19. CDC采集与数据入湖有什么关系？
无关联

20. CDC接入源系统的时间节点说明：
一般情况下，在业务需求使用CDC的场景中
    （1）CDC配置及CDC接入联调需一周时间
（2）上游系统完成开网流程和CDC配置下发需一周时间。注意：是完成下发，不是开始起流程
（3）CDC下发采集需一周时间

不考虑业务需求的SIT联调，UAT测试以及特殊情况，生产上接入CDC数据需至少三周时间。
如果有特殊情况，比如二十大重保，没有下发时间，相关的CDC都在当周完成之后，为了保证下发没问题，须告知上游系统：如果CDC接入有问题，步骤可以再次帮忙执行，而不用重新提流程执行（时间上来不及）。
原因：由于数据中心使用工具的关系，有些步骤可能存在适配问题，导致执行失败，进而影响CDC的接入。目前暂未收集到数据中心执行失败的原因，主要是复制后格式转换导致的，后续会尽可能添加步骤的核验

21. CDC能否采集存量数据？
CDC只采集增量数据，历史数据需要批量卸数（通过EDIP推送）

22. 源系统生产上接入CDC走运维流程还是软件下发流程？
请源系统老师找其生产的系统运维老师或者系统处老师确定

23. 如何清理日志，日志的传输方式是什么？
生产环境一般是数据中心已经配置清理策略，测试环境推荐rman，可以联调时联系实时数据服务项目组测试老师提供。
目前的采集不需要做日志传输，传输的是解析后的逻辑变更数据行。

24.生产上开通网络时，目标端口填写的是什么端口？
数据库端口。举例：Oracle默认是1521。

25.需求流程应该怎么走？
源系统领导审核之后转研发调度台（012366），研发调度台会自动转给大数据基础平台-实时数据服务项目组

26.源系统有跑批操作，CDC采集的数据会丢失吗？
不会，只是采集会有延迟

27.源系统配置下发和开网有没有先后顺序？
没有，开网是为CDC下发接入做准备的

28.如果源系统是双中心且双中心数据库没有同步会对CDC采集有影响吗？
理论上没有，CDC支持配置多个数据源，双中心可以看成两个数据库；如有此类操作，可以在测试环境提前测试

29.结束Xstream进程需要在执行步骤执行吗？
需要，配置CDC进程后，若不接入CDC会影响源系统日志清理，因为源系统和大数据平台不能保证同时下发，所以源系统只做配置验证，CDC进程由大数据平台维护，保证源系统CDC进程和CDC接入同时下发

30.Oracle数据库生产上由12升级到19，对CDC的相关配置需要在19上再执行吗？
版本12和19配置步骤是一样的，需要看升级后，CDC的相关配置是否也会同步过去，如未同步则需要再次配置

31.源系统配置下发之后需要注意什么？
源系统下发流程执行结束之后需告知实时数据服务项目组，我们之后会安排下发接入采集，并且反馈接入结果

32.开通生产网络如果是HA，需要填写HA地址还是实际主备机器地址？
需要都填上，CDC一般连HA，因为这个是虚拟地址，一个地址主备两台机器，所以切换的时候对外生产上几乎是无影响的；如果上游老师不愿意配合开通主机备机网络，HA通也可以

33.开通生产网络模板中目标名称是什么？
接入方数据库服务器名称

34.网络开通实时数据服务是源，目标是上游数据库服务器，为什么需要上游开网？
CDC的接入一般都是源系统提开网流程，指引里有说明；如果上游系统确实不方便开，实时数据服务项目组也可以提开网。

35.上游系统已做下发但未反馈checklist会有什么影响？
如果没有业务需求使用的话，CDC接入失败了也可以做二次调整，影响不大

36.CDC能接入日切表吗？
不能，主要是数据库产品原因，接入CDC存在较大的风险。目前已知的表中，核心三张流水表：基本信息表，账务信息表，往来信息表，都是日切表。
日切表含义：每天需要重命名旧表后再新建一模一样的表

37.需求流程的作用？
用于订阅源系统库中数据，提需求的业务要在需求中用到上游系统的数据，则需要经过源系统BA（业务）审核/授权同意后才能被订阅

38.上游系统提供给运维老师新建CDC用户密码是明文还是密文保存，密文保存的话加密方式是什么？
密文，加密方式不方便提供

39.生产环境中数据库已经部署，但还未建表，CDC能否接入？
MySQL，Informix可以，因为是库级别的授权；Oracle不行，因为是表级别的授权。

40.获取数据后，是否有一套规范保证数据的安全性？
可以目前大数据平台接收数据后会写入Kafka，Kafka是带有kerberos认证的，只有被授权才能查阅数据

41.系统是双中心模式需要都接入CDC吗？
如果单中心数据是完整的，接入一个中心即可，开通网络时需要把所有的网络都开通

42.反馈生产checklist有什么作用？
checklist是查询生产数据库中的一些信息，判断是否满足CDC的接入条件，可以起运维流程让系统处老师帮忙查询，把查询结果截图反馈，实时数据服务项目组会评估，如果不满足条件需另做调整

43.下发数据库配置是什么意思？
是指在生产上执行指引手册附录5.5的接入手册

44.生产网络能ping通但端口不通？
如果是连接被拒绝，询问上游老师是否是备库，备库可能未开所以不通，如果切换到备机，端口开了就通了

45.生产上的网络开通是单向的吗，实时数据服务项目组访问源系统数据库？
是的

46.Infomix锁表之后能做DML操作吗？
可以，Informix中被CDC采集的表都会被锁，不能做DDL操作，可以做DML操作，需要上游解锁才能继续DDL操作

47.开启补充日志，增强日志之后比只开归档日志大多少？
只新增补充日志和增强日志，日志增量很少，一般在5%以内

48.检查上游老师反馈的checklist需要检查什么？
（1）sga>20G并且stream pool size<1G 则设置stream pool size为1G；如果sga小于20G则实时组不接此上游 
（2）sysaux free如果小于10G，则需新增10G数据文件

49.数据库目前是两地三中心，CDC只需要在主中心接入吗？
是的

50.新增表/库授权需要走什么流程？
运维流程/软件下发流程，不用执行接入手册，上游提供授权步骤即可

51.开网验证时，对外服务IP是否需要连通？
主库通即可，因为对外提供服务IP端口可能暂未启用

52.上游系统已上线，新增表接入需要上游再次下发吗？



53.如果之后上游数据库涉及数据库服务重启，HA切换，需要通知实时组重启采集任务吗？重新开启采集任务之后会丢数吗？
需要；数据库重启会补采，具体参照问题6；HA切换会丢数。


54.业务老师提需求流程时，有多个上游系统需要一个系统一个需求流程吗？
是的，除非一个需求涉及少量例如一共两个系统，可以两个系统写在一个需求流程里面

55.业务老师提给实时组的需求流程与提给上游老师的需求有什么差别？
两个不同的需求：
1.提给上游的需求：与实时组没有关系，需要上游老师自己与业务老师沟通需求事宜
2.提给实时组的需求：需要过上游系统的BA（多数）或者SA，实时组与业务老师沟通需求事宜（如果上游BA或者SA不配合，也可以由源系统研发确认需求流程，但Informix系统一定需要源系统BA或者SA审核）

56.信息收集表中MySQL所属用户对于数据采集有影响吗？
没有，可以不填写

57.之前提的需求流程中附了信息收集表，之后新增表还需要在需求流程里面附信息收集表吗？
先把之前的信息收集表提供给上游老师，询问他们新增表是否也已经授权，如果没有授权则需要再附信息收集表

58.如果某张表涉及跑批操作，是否要做跑批测试？
Oracle一定需要，MySQL和Informix可以不测

59.主库做了CDC配置，但存在灾备切换，灾备需要做CDC配置吗？
如果进行短时间内灾备切换，这段时间的数据不在主库，则无法采集这部分数据，会存在数据丢失，但如果之后同步到主库，则仍能采集；若长时间有数据保留在灾备，则要考虑灾备配置CDC

60.CDC只在上海有机房吗？
目前是的

61. 开网跨区被驳回申请？
说明我们不是实时交易类场景，只是扫描数据库日志，读取数据变更，可以接受延迟

62. tdsql和txsql的mysql版本用什么接入手册
txsql（单节点）用现在的mysql接入手册，tdsql（集群）用新的接入手册（待更新）